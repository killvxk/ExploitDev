#include "stdafx.h"

int32_t wmain(int32_t nArgc, const wchar_t* pArgv[]) {
	shared_ptr<Interface> Intf = make_shared<Interface>(false, VerbosityLevel::Debug);
	shared_ptr<ApiTable> DynamicApis = make_shared<ApiTable>(Intf);

	if (nArgc < 3) {
		Intf->Log("... usage: %ws <PID> <DLL path>\r\n", pArgv[0]);
	}
	else {
		uint32_t dwPid = _wtoi(pArgv[1]);
		wstring DllPath = pArgv[2];

		if (GrantSelfSePrivilege(L"SeDebugPrivilege")) {
			Intf->Log("... successfully granted SeDebug privilege to self\r\n");
		}
		else {
			Intf->Log("... failed to grant SeDebug privilege to self\r\n");
		}

		try {
			Process Ps(Intf, DynamicApis, dwPid, L"");
			bool bValidTarget = false;
#ifdef _WIN64
			if (!Ps.IsWow64()) {
				bValidTarget = true;
			}
#else
			if (Ps.IsWow64()) {
				bValidTarget = true;
			}
#endif
			if (bValidTarget) {
				if (Ps.InjectDLL(DllPath)) {
					Intf->Log("... successfully injected %ws into %d\r\n", DllPath.c_str(), dwPid);
				}
				else {
					Intf->Log("... failed to inject %ws into %d\r\n", DllPath.c_str(), dwPid);
				}
			}
			else {
				Intf->Log("... target PID %d has a mismatching architecture with this tool (use the 32 or 64-bit version accordingly)\r\n", dwPid);
			}
		}
		catch (int32_t nError) {
			Intf->Log("... failed to initialize class object for PID %d\r\n", dwPid);
		}
	}

	return 0;
}